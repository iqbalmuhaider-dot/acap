<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kehadiran Koku (Firebase)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .hidden-section { display: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; }
            #view-report { display: block !important; }
            #view-teacher, #view-admin, #view-records, nav, #toast, #modal-confirm { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

    <!-- Navbar -->
    <nav class="bg-blue-800 text-white shadow-lg sticky top-0 z-50 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa-solid fa-clipboard-check text-xl"></i>
                <h1 class="text-lg font-bold hidden md:block">e-Hadir Koku SK HU</h1>
                <h1 class="text-lg font-bold md:hidden">e-Hadir</h1>
            </div>
            <div class="space-x-1 flex text-sm md:text-base">
                <button onclick="switchView('teacher')" id="btn-nav-teacher" class="px-3 py-2 rounded hover:bg-blue-700 transition font-medium bg-blue-900">
                    <i class="fa-solid fa-chalkboard-user mr-1"></i> Guru
                </button>
                <button onclick="switchView('records')" id="btn-nav-records" class="px-3 py-2 rounded hover:bg-blue-700 transition font-medium">
                    <i class="fa-solid fa-clock-rotate-left mr-1"></i> Rekod
                </button>
                <button onclick="switchView('admin')" id="btn-nav-admin" class="px-3 py-2 rounded hover:bg-blue-700 transition font-medium">
                    <i class="fa-solid fa-gear mr-1"></i> Admin
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6 max-w-5xl">

        <!-- Notification Toast -->
        <div id="toast" class="fixed top-20 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-50 flex items-center no-print">
            <i class="fa-solid fa-circle-check mr-2"></i>
            <span id="toast-msg">Operasi berjaya!</span>
        </div>

        <!-- VIEW: TEACHER PANEL -->
        <div id="view-teacher" class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-blue-600">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Borang Kehadiran</h2>
                    <div class="flex space-x-2 items-center">
                         <!-- Editing Indicator -->
                        <div id="edit-mode-indicator" class="hidden bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-bold animate-pulse">
                            <i class="fa-solid fa-pen mr-1"></i> Mod Edit
                        </div>
                        <div class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                            <i class="fa-solid fa-wifi mr-1"></i> <span id="teacher-db-status">Menyambung...</span>
                        </div>
                    </div>
                </div>
                
                <!-- Filters -->
                <div class="bg-blue-50 p-4 rounded-lg mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Kategori Aktiviti</label>
                            <select id="filter-category" onchange="updateUnitOptions()" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="">-- Pilih Kategori --</option>
                                <option value="uniform">Unit Beruniform</option>
                                <option value="club">Kelab & Persatuan</option>
                                <option value="sport">Sukan & Permainan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Nama Unit/Kelab/Sukan</label>
                            <select id="filter-unit" onchange="loadStudentsForAttendance()" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none" disabled>
                                <option value="">-- Sila Pilih Kategori Dulu --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Search & Class Filter -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-blue-200">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1"><i class="fa-solid fa-filter mr-1"></i>Tapis Kelas (Bantu Cari)</label>
                            <select id="filter-class" onchange="loadStudentsForAttendance()" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="all">Semua Kelas</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1"><i class="fa-solid fa-magnifying-glass mr-1"></i>Cari Nama Murid</label>
                            <input type="text" id="search-student" onkeyup="loadStudentsForAttendance()" placeholder="Taip nama murid..." class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="overflow-x-auto mb-6 max-h-[500px] overflow-y-auto border rounded">
                    <div class="flex justify-between items-center mb-2 p-2 bg-gray-50 sticky top-0 z-10 border-b">
                        <h3 class="text-lg font-semibold">Senarai Nama</h3>
                        <div class="text-sm text-gray-500" id="student-count">Memuatkan data...</div>
                    </div>
                    
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal sticky top-12 z-10">
                            <tr>
                                <th class="py-3 px-4 text-center w-16 bg-gray-100">
                                    <input type="checkbox" id="check-all" onclick="toggleAll(this)" class="w-5 h-5 text-blue-600 rounded cursor-pointer" checked>
                                </th>
                                <th class="py-3 px-4 bg-gray-100">Nama Murid</th>
                                <th class="py-3 px-4 bg-gray-100">Kelas</th>
                                <th class="py-3 px-4 bg-gray-100">Status</th>
                            </tr>
                        </thead>
                        <tbody id="attendance-list" class="text-gray-600 text-sm">
                            <tr>
                                <td colspan="4" class="text-center py-6 text-gray-400">Sila pilih kategori dan unit untuk memaparkan murid.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Activity Report Form Section -->
                <div class="bg-yellow-50 p-5 rounded-lg border border-yellow-200 mb-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-3"><i class="fa-solid fa-pen-to-square mr-2"></i>Laporan Aktiviti & Maklumat Guru</h3>
                    
                    <!-- NEW: Week & Time -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Minggu</label>
                            <input type="text" id="activity-week" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Cth: Minggu 1">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Masa</label>
                            <input type="text" id="activity-time" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Cth: 2.00 - 4.00 Petang">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                         <!-- Teacher Info -->
                         <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Nama Guru Bertugas</label>
                            <input type="text" id="teacher-name" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Cth: Cikgu Ahmad">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Jawatan</label>
                            <input type="text" id="teacher-position" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Cth: Guru Penasihat">
                        </div>
                    </div>

                    <div class="space-y-4 border-t border-yellow-200 pt-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Tajuk Aktiviti</label>
                            <input type="text" id="activity-topic" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Contoh: Latihan Kawad Kaki Asas">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Objektif Aktiviti</label>
                            <textarea id="activity-objective" rows="2" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="1. Murid dapat menguasai hukuman kawad..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Elemen KBAT (Manual)</label>
                            <input type="text" id="activity-kbat" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-yellow-500 outline-none" placeholder="Contoh: Mengaplikasi dan Menganalisis teknik kawad">
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button onclick="cancelEditMode()" id="btn-cancel-edit" class="hidden px-5 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition">Batal Edit</button>
                    <button onclick="resetAttendanceForm()" id="btn-reset" class="px-5 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition">Reset</button>
                    <button onclick="submitAttendance()" id="btn-submit-attendance" class="px-6 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 shadow-md transition flex items-center">
                        <i class="fa-solid fa-paper-plane mr-2"></i> Sahkan & Hantar Laporan
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: RECORDS PANEL (HISTORY) -->
        <div id="view-records" class="hidden-section space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md border-t-4 border-indigo-500">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Rekod Laporan Kehadiran</h2>
                <p class="text-sm text-gray-500 mb-6">Senarai laporan yang telah dihantar. Anda boleh kemaskini atau padam laporan di sini.</p>

                <!-- Record Filters -->
                <div class="flex flex-col md:flex-row gap-4 mb-6 bg-indigo-50 p-4 rounded-lg">
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Pilih Minggu</label>
                        <select id="record-filter-week" onchange="filterRecords()" class="w-full p-2 border rounded">
                            <option value="">-- Semua Minggu --</option>
                            <!-- Populated by JS -->
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Pilih Kategori</label>
                        <select id="record-filter-category" onchange="filterRecords()" class="w-full p-2 border rounded">
                            <option value="">-- Semua Kategori --</option>
                            <option value="uniform">Unit Beruniform</option>
                            <option value="club">Kelab & Persatuan</option>
                            <option value="sport">Sukan & Permainan</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReportsFromFirestore()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 w-full"><i class="fa-solid fa-rotate mr-2"></i> Refresh</button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 uppercase text-sm">
                            <tr>
                                <th class="p-3">Minggu / Tarikh</th>
                                <th class="p-3">Unit</th>
                                <th class="p-3">Aktiviti</th>
                                <th class="p-3 text-center">Kehadiran</th>
                                <th class="p-3 text-center w-40">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="records-list" class="text-sm text-gray-700 divide-y">
                            <tr><td colspan="5" class="p-4 text-center">Memuatkan rekod...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: REPORT RESULT -->
        <div id="view-report" class="hidden-section space-y-6">
            <div class="bg-white p-8 rounded-lg shadow-md border-t-4 border-green-500">
                
                <!-- Header Report -->
                <div class="text-center mb-8 border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-800 uppercase">Laporan Kehadiran Kokurikulum</h2>
                    <h3 class="text-xl font-semibold text-blue-800">SK HU</h3>
                    <p class="text-gray-500 mt-2" id="report-date">-</p>
                </div>

                <!-- Info Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Activity Details Card -->
                    <div class="bg-gray-50 p-5 rounded border shadow-sm">
                        <h3 class="font-bold text-gray-700 border-b pb-2 mb-3">Butiran Aktiviti</h3>
                        <div class="space-y-3 text-sm">
                             <div>
                                <span class="block font-semibold text-gray-600">Unit:</span>
                                <span class="block text-blue-800 font-bold" id="report-unit">-</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-600">Minggu:</span>
                                <span class="block text-gray-800" id="report-week-display">-</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-600">Masa:</span>
                                <span class="block text-gray-800" id="report-time-display">-</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-600">Aktiviti:</span>
                                <span class="block text-gray-800" id="report-topic-display">-</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-600">Objektif:</span>
                                <span class="block text-gray-800 whitespace-pre-line" id="report-objective-display">-</span>
                            </div>
                            <div>
                                <span class="block font-semibold text-gray-600">KBAT:</span>
                                <span class="block text-gray-800 italic" id="report-kbat-display">-</span>
                            </div>
                        </div>
                    </div>

                     <!-- Stat Card -->
                     <div class="bg-gray-50 p-5 rounded border shadow-sm flex flex-col justify-between">
                        <div>
                            <h3 class="font-bold text-gray-700 border-b pb-2 mb-3">Statistik Kehadiran</h3>
                            <div class="grid grid-cols-2 gap-4 mt-4 text-center">
                                <div class="bg-green-100 p-4 rounded">
                                    <span class="block text-sm text-green-700">Hadir</span>
                                    <span class="block text-3xl font-bold text-green-800" id="report-present">0</span>
                                </div>
                                <div class="bg-red-100 p-4 rounded">
                                    <span class="block text-sm text-red-700">Tidak Hadir</span>
                                    <span class="block text-3xl font-bold text-red-800" id="report-absent">0</span>
                                </div>
                            </div>
                            <p class="text-xs text-center text-gray-500 mt-2 italic">*Mengambil kira semua ahli unit walaupun berlainan kelas</p>
                        </div>
                    </div>
                </div>

                <!-- Attendance List -->
                <div class="border rounded-lg overflow-hidden mb-8">
                    <div class="bg-gray-800 text-white px-4 py-2 border-b font-bold text-sm">Senarai Kehadiran Murid</div>
                    <ul id="report-full-list" class="divide-y divide-gray-200 text-sm">
                        <!-- List populated by JS -->
                    </ul>
                </div>

                <!-- Teacher Signature Section -->
                <div class="flex justify-end mt-12 pr-10 page-break-inside-avoid">
                    <div class="text-center w-64">
                        <div class="h-16"></div> <!-- Space for signature -->
                        <div class="border-t border-gray-400 pt-2">
                            <p class="font-bold text-gray-800" id="report-teacher-name">Nama Guru</p>
                            <p class="text-sm text-gray-600" id="report-teacher-pos">Jawatan</p>
                            <p class="text-xs text-gray-400 mt-1">Disahkan melalui e-Hadir Koku SK HU</p>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-center no-print">
                    <button onclick="window.print()" class="px-6 py-2 bg-gray-700 text-white rounded hover:bg-gray-800 transition mr-2">
                        <i class="fa-solid fa-print mr-2"></i> Cetak / Simpan PDF
                    </button>
                    <button onclick="switchView('records')" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                        Kembali ke Rekod
                    </button>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN PANEL -->
        <div id="view-admin" class="hidden-section space-y-6">
            
            <!-- Add Student & CSV -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- CSV Upload -->
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-purple-500">
                    <h3 class="font-bold text-lg mb-3"><i class="fa-solid fa-file-csv mr-2"></i>Import CSV</h3>
                    
                    <!-- File Input Area -->
                    <div class="mb-4 bg-purple-50 p-3 rounded border border-purple-100">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">1. Muat Naik Fail Excel/CSV</label>
                        <input type="file" id="file-upload" accept=".csv" onchange="handleFileSelect(this)" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-200 file:text-purple-700 hover:file:bg-purple-300 transition cursor-pointer"/>
                    </div>

                    <p class="text-xs text-gray-500 mb-2 font-semibold">2. Atau Tampal Manual (Format: Nama Murid, Kelas, Unit Beruniform, Kelab Persatuan, Sukan Permainan)</p>
                    <textarea id="csv-input" rows="5" class="w-full p-2 border rounded text-sm mb-3 focus:ring-2 focus:ring-purple-300 font-mono text-xs" placeholder="Contoh:
Ali Bin Abu, 5 Inovatif, Pengakap, Bahasa Melayu, Bola Sepak
Siti Aminah, 4 Kreatif, PBSM, STEM, Bola Jaring"></textarea>
                    <button onclick="processCSV()" id="btn-import" class="w-full bg-purple-600 text-white py-2 rounded hover:bg-purple-700 transition font-bold"><i class="fa-solid fa-upload mr-2"></i>Proses & Simpan ke Database</button>
                </div>

                <!-- Manual Add -->
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-orange-500">
                    <h3 class="font-bold text-lg mb-3"><i class="fa-solid fa-user-plus mr-2"></i>Tambah Murid Manual</h3>
                    <form onsubmit="event.preventDefault(); addStudentManual();" class="space-y-2">
                        <input type="text" id="add-name" placeholder="Nama Penuh" class="w-full p-2 border rounded text-sm" required>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="add-class" placeholder="Kelas" class="w-full p-2 border rounded text-sm" required>
                            <input type="text" id="add-uniform" placeholder="Unit Beruniform" class="w-full p-2 border rounded text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="add-club" placeholder="Kelab/Persatuan" class="w-full p-2 border rounded text-sm">
                            <input type="text" id="add-sport" placeholder="Sukan/Permainan" class="w-full p-2 border rounded text-sm">
                        </div>
                        <button type="submit" id="btn-add-manual" class="w-full bg-orange-500 text-white py-2 rounded hover:bg-orange-600 transition">Simpan ke Database</button>
                    </form>
                </div>
            </div>

            <!-- Student List -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-2">
                    <h3 class="font-bold text-lg">Senarai Murid (Database)</h3>
                    
                    <!-- Admin Class Filter -->
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-semibold text-gray-700">Tapis Kelas:</label>
                        <select id="admin-filter-class" onchange="renderAdminTable()" class="p-1 border border-gray-300 rounded text-sm focus:ring-blue-500">
                            <option value="all">Semua Kelas</option>
                            <!-- JS populated -->
                        </select>
                    </div>

                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-green-600 font-bold" id="db-status">Online</span>
                        <button onclick="clearAllData()" class="text-xs text-red-500 hover:text-red-700 underline ml-2">Padam Semua</button>
                    </div>
                </div>
                
                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 sticky top-0">
                            <tr class="text-xs text-gray-600 uppercase">
                                <th class="p-3">Nama</th>
                                <th class="p-3">Kelas</th>
                                <th class="p-3">Unit</th>
                                <th class="p-3">Kelab</th>
                                <th class="p-3">Sukan</th>
                                <th class="p-3 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="admin-student-list" class="text-sm text-gray-700 divide-y">
                            <tr><td colspan="6" class="p-4 text-center">Memuatkan data dari Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Confirm Delete (Generic) -->
    <div id="modal-confirm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 no-print">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
            <h3 class="text-lg font-bold mb-2">Sahkan Tindakan?</h3>
            <p id="modal-msg" class="text-gray-600 mb-4 text-sm">Adakah anda pasti mahu meneruskan tindakan ini?</p>
            <div class="flex justify-end space-x-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Batal</button>
                <button id="btn-confirm-action" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Ya, Sahkan</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic (Modular SDK) -->
    <script type="module">
        // Import Firebase Functions from CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, writeBatch, query, orderBy, Timestamp, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC7YV0W6kVRKG--BhETIFcx8ej2-TbrWGI",
            authDomain: "e-kehadiran-kokurikulum-sk-hu.firebaseapp.com",
            projectId: "e-kehadiran-kokurikulum-sk-hu",
            storageBucket: "e-kehadiran-kokurikulum-sk-hu.firebasestorage.app",
            messagingSenderId: "883745738702",
            appId: "1:883745738702:web:dda2fe8ada4646f8b3a59f",
            measurementId: "G-ZM8DL8HMBP"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global State
        let students = [];
        let reports = [];
        let isLoading = false;
        let currentReportId = null; // Used for editing
        
        // Attendance State Management (ID -> boolean)
        // true = Hadir (default), false = Tidak Hadir
        let attendanceMap = new Map(); 

        // Initialize Helper for View Report immediately
        window.viewReportData = function(obj) {
            let fullReport = null;
            if(obj.topic) {
                fullReport = obj;
            } else if (obj.id) {
                fullReport = reports.find(r => r.id === obj.id);
            }

            if(fullReport && window.displayReport) {
                window.displayReport(fullReport);
            } else {
                console.error("Report data not found or displayReport function missing.");
            }
        }

        // --- Auth & Initial Load ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const statusElems = ['db-status', 'teacher-db-status'];
                statusElems.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.innerText = "Online";
                        el.className = "text-xs text-green-600 font-bold";
                    }
                });
                loadStudentsFromFirestore();
            } else {
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error", error);
                    showToast("Gagal menyambung ke database", true);
                });
            }
        });

        // --- Firestore Functions ---
        
        async function loadStudentsFromFirestore() {
            isLoading = true;
            const tbody = document.getElementById('admin-student-list');
            
            try {
                // Get students collection
                const q = query(collection(db, "students"), orderBy("name"));
                const querySnapshot = await getDocs(q);
                
                students = [];
                querySnapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });

                renderAdminTable();
                populateClassFilter(); // Update filters for teacher view
                
            } catch (e) {
                console.error("Error loading: ", e);
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuatkan data. Sila refresh.</td></tr>`;
            } finally {
                isLoading = false;
            }
        }

        // Load Reports Function
        window.loadReportsFromFirestore = async function() {
            const tbody = document.getElementById('records-list');
            tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center">Memuatkan data terkini...</td></tr>`;

            try {
                const q = query(collection(db, "reports"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                
                reports = [];
                querySnapshot.forEach((doc) => {
                    reports.push({ id: doc.id, ...doc.data() });
                });

                populateRecordWeekFilter(); // Populate Weeks
                filterRecords(); // Render list
                
            } catch (e) {
                console.error("Error loading reports: ", e);
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Gagal memuatkan rekod.</td></tr>`;
            }
        }

        window.submitAttendance = async function() {
            const btn = document.getElementById('btn-submit-attendance');
            const category = document.getElementById('filter-category').value;
            const unit = document.getElementById('filter-unit').value;
            const week = document.getElementById('activity-week').value;
            const time = document.getElementById('activity-time').value;
            const topic = document.getElementById('activity-topic').value;
            const objective = document.getElementById('activity-objective').value;
            const kbat = document.getElementById('activity-kbat').value;
            const teacherName = document.getElementById('teacher-name').value;
            const teacherPos = document.getElementById('teacher-position').value;
            
            if(!category || !unit) return showToast("Sila pilih Unit dahulu!", true);
            if(!teacherName) return showToast("Sila masukkan Nama Guru!", true);
            if(!week || !time || !topic || !objective || !kbat) return showToast("Sila lengkapkan semua maklumat laporan!", true);

            btn.disabled = true;
            btn.innerText = currentReportId ? "Mengemaskini..." : "Menghantar...";

            // CALCULATION LOGIC CHANGE:
            // Filter ALL students for this unit (ignoring class filter)
            const allUnitStudents = students.filter(s => s[category] === unit);
            
            if(allUnitStudents.length === 0) {
                 btn.disabled = false;
                 btn.innerText = "Sahkan & Hantar Laporan";
                 return showToast("Tiada murid dalam unit ini.", true);
            }

            let presentCount = 0;
            let absentCount = 0;
            let allStudentsStatus = [];

            // Loop through ALL students in this unit to calculate final status
            allUnitStudents.forEach(s => {
                // If ID is in map, use it. If not, default to TRUE (Hadir)
                const isPresent = attendanceMap.has(s.id) ? attendanceMap.get(s.id) : true;
                
                if (isPresent) presentCount++; else absentCount++;
                
                allStudentsStatus.push({ 
                    name: s.name, 
                    class: s.class, 
                    status: isPresent ? 'Hadir' : 'Tidak Hadir' 
                });
            });

            // Sort list by status (Absent first), then class
            allStudentsStatus.sort((a, b) => {
                if (a.status !== b.status) return a.status === 'Tidak Hadir' ? -1 : 1;
                return a.class.localeCompare(b.class);
            });

            const reportData = {
                date: new Date(),
                dateString: new Date().toLocaleDateString('ms-MY'),
                category,
                unit,
                week,
                time,
                topic,
                objective,
                kbat,
                teacherName,
                teacherPos,
                presentCount,
                absentCount,
                attendees: allStudentsStatus
            };

            try {
                if (currentReportId) {
                    await updateDoc(doc(db, "reports", currentReportId), reportData);
                    showToast("Laporan berjaya dikemaskini!");
                } else {
                    await addDoc(collection(db, "reports"), reportData);
                    showToast("Laporan berjaya dihantar!");
                }
                
                if (window.displayReport) window.displayReport(reportData);
                
                // Reset edit mode & state
                currentReportId = null;
                attendanceMap.clear(); // Clear memory after submit
                document.getElementById('edit-mode-indicator').classList.add('hidden');
                document.getElementById('btn-cancel-edit').classList.add('hidden');
                document.getElementById('btn-reset').classList.remove('hidden');
                document.getElementById('btn-submit-attendance').innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i> Sahkan & Hantar Laporan`;

            } catch (e) {
                console.error("Error saving report: ", e);
                showToast("Gagal menyimpan laporan. Sila cuba lagi.", true);
            } finally {
                btn.disabled = false;
                if(!currentReportId) btn.innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i> Sahkan & Hantar Laporan`;
            }
        }

        window.deleteReport = function(id) {
            const modal = document.getElementById('modal-confirm');
            const msg = document.getElementById('modal-msg');
            const confirmBtn = document.getElementById('btn-confirm-action');

            msg.innerText = "Adakah anda pasti mahu memadam laporan ini? Ia tidak boleh dikembalikan.";
            modal.classList.remove('hidden');

            confirmBtn.onclick = async function() {
                confirmBtn.innerText = "Memadam...";
                confirmBtn.disabled = true;
                try {
                    await deleteDoc(doc(db, "reports", id));
                    showToast("Laporan dipadam.");
                    window.loadReportsFromFirestore();
                    modal.classList.add('hidden');
                } catch(e) {
                    showToast("Gagal memadam.", true);
                } finally {
                    confirmBtn.innerText = "Ya, Sahkan";
                    confirmBtn.disabled = false;
                }
            }
        }

        window.editReport = function(id) {
            const report = reports.find(r => r.id === id);
            if(!report) return;

            currentReportId = id;
            attendanceMap.clear(); // Clear current state
            
            // Switch to teacher view
            switchView('teacher');
            
            // Populate state map from report
            report.attendees.forEach(a => {
                // We need to map Name back to ID if possible. 
                // Since report stores Name/Class/Status but not ID directly in older versions, 
                // we try to find the student in current list by name
                const student = students.find(s => s.name === a.name && s.class === a.class);
                if(student) {
                    attendanceMap.set(student.id, a.status === 'Hadir');
                }
            });

            // Set UI to Edit Mode
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-reset').classList.add('hidden');
            document.getElementById('btn-submit-attendance').innerHTML = `<i class="fa-solid fa-pen-to-square mr-2"></i> Kemaskini Laporan`;

            // Populate Fields
            document.getElementById('filter-category').value = report.category;
            updateUnitOptions(); 
            document.getElementById('filter-unit').value = report.unit;
            document.getElementById('activity-week').value = report.week || '';
            document.getElementById('activity-time').value = report.time || '';
            document.getElementById('activity-topic').value = report.topic;
            document.getElementById('activity-objective').value = report.objective;
            document.getElementById('activity-kbat').value = report.kbat;
            document.getElementById('teacher-name').value = report.teacherName;
            document.getElementById('teacher-position').value = report.teacherPos;

            loadStudentsForAttendance();
            showToast("Mod Edit diaktifkan.");
        }

        window.cancelEditMode = function() {
            currentReportId = null;
            attendanceMap.clear();
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-reset').classList.remove('hidden');
            document.getElementById('btn-submit-attendance').innerHTML = `<i class="fa-solid fa-paper-plane mr-2"></i> Sahkan & Hantar Laporan`;
            resetAttendanceForm();
            showToast("Mod Edit dibatalkan.");
        }

        // --- Admin Functions ---
        window.addStudentManual = async function() {
            const name = document.getElementById('add-name').value;
            const cls = document.getElementById('add-class').value;
            const uni = document.getElementById('add-uniform').value;
            const club = document.getElementById('add-club').value;
            const sport = document.getElementById('add-sport').value;
            const btn = document.getElementById('btn-add-manual');

            if(!name || !cls) return showToast("Nama dan Kelas wajib diisi!", true);

            btn.disabled = true;
            btn.innerText = "Menyimpan...";

            try {
                await addDoc(collection(db, "students"), {
                    name: name,
                    class: cls,
                    uniform: uni || "-",
                    club: club || "-",
                    sport: sport || "-",
                    createdAt: new Date()
                });
                
                showToast("Murid berjaya ditambah!");
                document.getElementById('add-name').value = '';
                document.getElementById('add-class').value = '';
                document.getElementById('add-uniform').value = '';
                document.getElementById('add-club').value = '';
                document.getElementById('add-sport').value = '';
                loadStudentsFromFirestore();
            } catch (e) {
                console.error("Error adding: ", e);
                showToast("Gagal menyimpan data", true);
            } finally {
                btn.disabled = false;
                btn.innerText = "Simpan ke Database";
            }
        }

        window.processCSV = async function() {
            const input = document.getElementById('csv-input').value;
            const btn = document.getElementById('btn-import');
            
            if (!input.trim()) return showToast("Sila masukkan data CSV", true);
            
            btn.disabled = true;
            btn.innerText = "Sedang memproses...";

            const lines = input.split('\n');
            const batch = writeBatch(db);
            let batchCount = 0;
            let addedCount = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                if (!line.trim()) continue;
                const cols = line.split(',').map(c => c.trim());
                if (i === 0 && cols[0].toLowerCase().includes('nama') && cols[1].toLowerCase().includes('kelas')) continue;

                if (cols.length >= 2) {
                    const newDocRef = doc(collection(db, "students"));
                    batch.set(newDocRef, {
                        name: cols[0],
                        class: cols[1],
                        uniform: cols[2] || "-",
                        club: cols[3] || "-",
                        sport: cols[4] || "-",
                        createdAt: new Date()
                    });
                    batchCount++;
                    addedCount++;
                }
            }

            if (batchCount > 0) {
                try {
                    await batch.commit();
                    showToast(`${addedCount} murid berjaya disimpan!`);
                    document.getElementById('csv-input').value = '';
                    document.getElementById('file-upload').value = '';
                    loadStudentsFromFirestore();
                } catch (e) {
                    console.error("Batch error: ", e);
                    showToast("Gagal menyimpan.", true);
                }
            } else {
                showToast("Tiada data sah.", true);
            }
            btn.disabled = false;
            btn.innerText = "Proses & Simpan ke Database";
        }

        window.triggerDeleteStudent = function(id) {
            const modal = document.getElementById('modal-confirm');
            const msg = document.getElementById('modal-msg');
            const confirmBtn = document.getElementById('btn-confirm-action');

            msg.innerText = "Adakah anda pasti mahu memadam murid ini? Data akan hilang dari database.";
            modal.classList.remove('hidden');

            confirmBtn.onclick = async function() {
                confirmBtn.innerText = "Memadam...";
                confirmBtn.disabled = true;
                try {
                    await deleteDoc(doc(db, "students", id));
                    showToast("Murid dipadam.");
                    window.loadStudentsFromFirestore(); // Reload admin list
                    modal.classList.add('hidden');
                } catch(e) {
                    showToast("Gagal memadam.", true);
                } finally {
                    confirmBtn.innerText = "Ya, Sahkan";
                    confirmBtn.disabled = false;
                }
            }
        }
        
        window.deleteStudent = window.triggerDeleteStudent;
        window.loadStudentsFromFirestore = loadStudentsFromFirestore;

        window.performClearAll = async function() {
            const modal = document.getElementById('modal-confirm');
            const msg = document.getElementById('modal-msg');
            const confirmBtn = document.getElementById('btn-confirm-action');

            msg.innerText = "Adakah anda pasti mahu memadam SEMUA data murid? Data ini tidak boleh dikembalikan.";
            modal.classList.remove('hidden');

            confirmBtn.onclick = async function() {
               if(window.performClearAll) {
                   alert("Sila gunakan butang Padam di dalam modul Admin untuk fungsi ini.");
                   modal.classList.add('hidden');
               }
            }
        }
        
        // --- Helpers for State Management ---

        window.updateAttendanceState = function(id, isChecked) {
            attendanceMap.set(id, isChecked);
        }

        window.toggleAllAttendanceState = function(isChecked, visibleIds) {
            visibleIds.forEach(id => attendanceMap.set(id, isChecked));
        }

        // Render Admin Table with Filter
        window.renderAdminTable = function() {
            const tbody = document.getElementById('admin-student-list');
            const filterClass = document.getElementById('admin-filter-class').value;

            tbody.innerHTML = '';
            
            if (students.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">Tiada data murid.</td></tr>`;
                return;
            }

            const displayedStudents = students.filter(s => filterClass === 'all' || s.class === filterClass);

            if (displayedStudents.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-gray-400">Tiada murid dalam kelas ini.</td></tr>`;
                return;
            }

            displayedStudents.forEach((s) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b";
                tr.innerHTML = `
                    <td class="p-3 font-medium">${s.name}</td>
                    <td class="p-3">${s.class}</td>
                    <td class="p-3">${s.uniform}</td>
                    <td class="p-3">${s.club}</td>
                    <td class="p-3">${s.sport}</td>
                    <td class="p-3 text-center">
                        <button onclick="deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700 bg-red-100 p-2 rounded-full h-8 w-8 flex items-center justify-center mx-auto"><i class="fa-solid fa-trash text-xs"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.populateRecordWeekFilter = function() {
            const weekSelect = document.getElementById('record-filter-week');
            // Get unique weeks, filter out empty/undefined, sort them
            const weeks = [...new Set(reports.map(r => r.week).filter(w => w))].sort();
            
            // Save current selection if possible
            const currentVal = weekSelect.value;
            
            weekSelect.innerHTML = '<option value="">-- Semua Minggu --</option>';
            weeks.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w;
                opt.innerText = w;
                weekSelect.appendChild(opt);
            });
            
            if(weeks.includes(currentVal)) weekSelect.value = currentVal;
        }

        window.filterRecords = function() {
            const filterWeek = document.getElementById('record-filter-week').value;
            const filterCategory = document.getElementById('record-filter-category').value;
            const tbody = document.getElementById('records-list');
            
            tbody.innerHTML = '';

            const filtered = reports.filter(r => {
                const weekMatch = filterWeek === "" || r.week === filterWeek;
                const categoryMatch = filterCategory === "" || r.category === filterCategory;
                return weekMatch && categoryMatch;
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-400">Tiada rekod ditemui untuk minggu ini.</td></tr>`;
                return;
            }

            filtered.forEach((r, index) => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-indigo-50 border-b transition";
                
                let displayDate = r.dateString;
                if(r.date && r.date.seconds) {
                    displayDate = new Date(r.date.seconds * 1000).toLocaleDateString('ms-MY');
                }

                // Show week alongside date
                const displayWeek = r.week ? `(${r.week})` : '';

                tr.innerHTML = `
                    <td class="p-3 font-medium text-indigo-700 cursor-pointer" onclick="viewReportData({id: '${r.id}'})">
                        ${displayDate} <span class="text-xs text-gray-500 block">${displayWeek}</span>
                    </td>
                    <td class="p-3 font-bold cursor-pointer" onclick="viewReportData({id: '${r.id}'})">${r.unit}</td>
                    <td class="p-3 text-gray-600 truncate max-w-xs cursor-pointer" onclick="viewReportData({id: '${r.id}'})">${r.topic}</td>
                    <td class="p-3 text-center cursor-pointer" onclick="viewReportData({id: '${r.id}'})">
                        <span class="text-green-600 font-bold">${r.presentCount}</span> / 
                        <span class="text-red-500 font-bold">${r.absentCount}</span>
                    </td>
                    <td class="p-3 text-center flex justify-center space-x-2">
                        <button onclick="viewReportData({id: '${r.id}'})" class="text-blue-600 hover:text-blue-800" title="Lihat"><i class="fa-solid fa-eye"></i></button>
                        <button onclick="editReport('${r.id}')" class="text-yellow-600 hover:text-yellow-800" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                        <button onclick="deleteReport('${r.id}')" class="text-red-600 hover:text-red-800" title="Padam"><i class="fa-solid fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.getUniqueValues = function(key) {
            const values = students.map(s => s[key]).filter(v => v && v !== '-');
            return [...new Set(values)].sort();
        }

        window.populateClassFilter = function() {
            const teacherSelect = document.getElementById('filter-class');
            const adminSelect = document.getElementById('admin-filter-class');
            
            const uniqueClasses = window.getUniqueValues('class');
            const optionsHTML = '<option value="all">Semua Kelas</option>' + 
                uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');

            teacherSelect.innerHTML = optionsHTML;
            adminSelect.innerHTML = optionsHTML; 
        }

        window.updateUnitOptions = function() {
            const category = document.getElementById('filter-category').value;
            const unitSelect = document.getElementById('filter-unit');
            unitSelect.innerHTML = '<option value="">-- Pilih Unit --</option>';
            document.getElementById('attendance-list').innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-400">Sila pilih unit khusus.</td></tr>';
            
            // Clear attendance map when unit changes
            attendanceMap.clear();

            if (!category) { unitSelect.disabled = true; return; }
            unitSelect.disabled = false;
            window.getUniqueValues(category).forEach(unit => {
                const opt = document.createElement('option');
                opt.value = unit; opt.innerText = unit; unitSelect.appendChild(opt);
            });
        }

        window.loadStudentsForAttendance = function() {
            const category = document.getElementById('filter-category').value;
            const selectedUnit = document.getElementById('filter-unit').value;
            const selectedClass = document.getElementById('filter-class').value;
            const searchText = document.getElementById('search-student').value.toLowerCase();
            
            const listBody = document.getElementById('attendance-list');
            const countDisplay = document.getElementById('student-count');
            
            document.getElementById('check-all').checked = true;

            if (!category || !selectedUnit) {
                listBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-400">Sila pilih kategori dan nama unit.</td></tr>';
                countDisplay.innerText = "0 Murid";
                return;
            }

            const filteredStudents = students.filter(s => {
                const matchUnit = s[category] === selectedUnit;
                const matchClass = selectedClass === 'all' || s.class === selectedClass;
                const matchSearch = s.name.toLowerCase().includes(searchText);
                return matchUnit && matchClass && matchSearch;
            });

            filteredStudents.sort((a, b) => a.class.localeCompare(b.class) || a.name.localeCompare(b.name));
            countDisplay.innerText = `${filteredStudents.length} Murid`;

            if (filteredStudents.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-yellow-600 bg-yellow-50 rounded">Tiada murid ditemui untuk kriteria ini.</td></tr>';
                return;
            }

            listBody.innerHTML = '';
            filteredStudents.forEach(s => {
                // Determine checked state from Map or Default True
                const isChecked = attendanceMap.has(s.id) ? attendanceMap.get(s.id) : true;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 border-b transition";
                tr.innerHTML = `
                    <td class="p-3 text-center bg-white">
                        <input type="checkbox" name="attendance_check" value="${s.id}" data-name="${s.name}" data-class="${s.class}" class="w-5 h-5 text-blue-600 rounded cursor-pointer" ${isChecked ? 'checked' : ''} onchange="handleCheckboxChange(this, '${s.id}')">
                    </td>
                    <td class="p-3 font-medium text-gray-800 bg-white">${s.name}</td>
                    <td class="p-3 text-gray-600 text-xs font-bold bg-white"><span class="bg-gray-200 px-2 py-1 rounded">${s.class}</span></td>
                    <td class="p-3 text-sm font-bold ${isChecked ? 'text-green-600' : 'text-red-500'} status-text bg-white">${isChecked ? 'HADIR' : 'TIDAK HADIR'}</td>
                `;
                listBody.appendChild(tr);
            });
        }

    </script>

    <!-- Standard JS Logic -->
    <script>
        function switchView(viewName) {
            document.getElementById('view-teacher').classList.add('hidden-section');
            document.getElementById('view-admin').classList.add('hidden-section');
            document.getElementById('view-report').classList.add('hidden-section');
            document.getElementById('view-records').classList.add('hidden-section');
            
            document.getElementById(`view-${viewName}`).classList.remove('hidden-section');

            const btnTeacher = document.getElementById('btn-nav-teacher');
            const btnRecords = document.getElementById('btn-nav-records');
            const btnAdmin = document.getElementById('btn-nav-admin');
            
            // Reset nav styles
            [btnTeacher, btnRecords, btnAdmin].forEach(btn => btn.classList.remove('bg-blue-900'));

            if(viewName === 'teacher') {
                btnTeacher.classList.add('bg-blue-900');
                if(window.populateClassFilter) window.populateClassFilter(); 
            } else if (viewName === 'records') {
                btnRecords.classList.add('bg-blue-900');
                if(window.loadReportsFromFirestore) window.loadReportsFromFirestore();
            } else if (viewName === 'admin') {
                btnAdmin.classList.add('bg-blue-900');
                if(window.renderAdminTable) window.renderAdminTable();
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            msg.innerText = message;
            toast.className = `fixed top-20 right-5 px-6 py-3 rounded shadow-xl transform transition-transform duration-300 z-50 flex items-center ${isError ? 'bg-red-600' : 'bg-green-600'} text-white translate-x-0 no-print`;
            setTimeout(() => { toast.classList.add('translate-x-full'); }, 3000);
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('csv-input').value = e.target.result;
                showToast("Fail dibaca. Klik butang proses untuk simpan.");
            };
            reader.readAsText(file);
        }

        function clearAllData() { 
            const modal = document.getElementById('modal-confirm');
            const msg = document.getElementById('modal-msg');
            const confirmBtn = document.getElementById('btn-confirm-action');

            msg.innerText = "Adakah anda pasti mahu memadam SEMUA data murid? Data ini tidak boleh dikembalikan.";
            modal.classList.remove('hidden');

            confirmBtn.onclick = async function() {
               if(window.performClearAll) {
                   alert("Sila gunakan butang Padam di dalam modul Admin untuk fungsi ini.");
                   modal.classList.add('hidden');
               }
            }
        }
        
        function closeModal() {
            document.getElementById('modal-confirm').classList.add('hidden');
        }

        // Added missing function wrapper
        function handleCheckboxChange(checkbox, id) {
             if(window.updateAttendanceState) {
                 window.updateAttendanceState(id, checkbox.checked);
             }
             updateRowStatus(checkbox);
        }

        function updateRowStatus(checkbox) {
            const row = checkbox.closest('tr');
            const statusText = row.querySelector('.status-text');
            if(checkbox.checked) {
                statusText.innerText = "HADIR";
                statusText.className = "p-3 text-sm font-bold text-green-600 status-text bg-white";
            } else {
                statusText.innerText = "TIDAK HADIR";
                statusText.className = "p-3 text-sm font-bold text-red-500 status-text bg-white";
            }
        }

        function toggleAll(source) {
            const checkboxes = document.getElementsByName('attendance_check');
            let visibleIds = [];
            
            for(let i=0, n=checkboxes.length;i<n;i++) {
                checkboxes[i].checked = source.checked;
                updateRowStatus(checkboxes[i]);
                // Collect IDs to update state
                visibleIds.push(checkboxes[i].value); 
            }

            if(window.toggleAllAttendanceState) {
                window.toggleAllAttendanceState(source.checked, visibleIds);
            }
        }

        function resetAttendanceForm() {
            document.getElementById('filter-category').value = "";
            window.updateUnitOptions();
            document.getElementById('filter-class').value = "all";
            document.getElementById('search-student').value = ""; // Reset search
            document.getElementById('check-all').checked = true;
            document.getElementById('activity-week').value = "";
            document.getElementById('activity-time').value = "";
            document.getElementById('activity-topic').value = "";
            document.getElementById('activity-objective').value = "";
            document.getElementById('activity-kbat').value = "";
            document.getElementById('teacher-name').value = "";
            document.getElementById('teacher-position').value = "";
            
            // Exit Edit Mode if active
            if(window.cancelEditMode) window.cancelEditMode();
        }

        // Shared View Report Function
        window.displayReport = function(data) {
            // Hide all views first
            document.getElementById('view-teacher').classList.add('hidden-section');
            document.getElementById('view-admin').classList.add('hidden-section');
            document.getElementById('view-records').classList.add('hidden-section');
            document.getElementById('view-report').classList.remove('hidden-section');

            // Handle date format (Firestore Timestamp vs JS Date)
            let dateStr = data.dateString;
            if(!dateStr && data.date && data.date.seconds) {
                 dateStr = new Date(data.date.seconds * 1000).toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } else if (data.date instanceof Date) {
                 dateStr = data.date.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }

            document.getElementById('report-date').innerText = dateStr || '-';
            document.getElementById('report-unit').innerText = data.unit;
            document.getElementById('report-present').innerText = data.presentCount;
            document.getElementById('report-absent').innerText = data.absentCount;
            
            document.getElementById('report-week-display').innerText = data.week || '-';
            document.getElementById('report-time-display').innerText = data.time || '-';
            document.getElementById('report-topic-display').innerText = data.topic;
            document.getElementById('report-objective-display').innerText = data.objective;
            document.getElementById('report-kbat-display').innerText = data.kbat;

            document.getElementById('report-teacher-name').innerText = data.teacherName;
            document.getElementById('report-teacher-pos').innerText = data.teacherPos;

            const listContainer = document.getElementById('report-full-list');
            listContainer.innerHTML = '';
            
            // Sort Attendees
            const attendees = data.attendees || [];
            attendees.sort((a, b) => (a.status === 'Tidak Hadir' ? -1 : 1));

            attendees.forEach(s => {
                const li = document.createElement('li');
                li.className = "px-4 py-3 flex justify-between items-center bg-white border-b";
                const statusColor = s.status === 'Hadir' ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50 font-bold';
                li.innerHTML = `
                    <div class="flex items-center">
                        <span class="w-6 text-xs text-gray-400 mr-2 text-center"><i class="fa-solid fa-user"></i></span>
                        <div>
                            <span class="font-medium text-gray-800 block">${s.name}</span>
                            <span class="text-xs text-gray-500">${s.class}</span>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs border ${statusColor}">${s.status.toUpperCase()}</span>
                `;
                listContainer.appendChild(li);
            });
        }
    </script>
</body>
</html>
